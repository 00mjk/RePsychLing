<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>Singularity in the Cholesky factor</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>

<!-- Styles for R syntax highlighter -->
<style type="text/css">
   pre .operator,
   pre .paren {
     color: rgb(104, 118, 135)
   }

   pre .literal {
     color: #990073
   }

   pre .number {
     color: #099;
   }

   pre .comment {
     color: #998;
     font-style: italic
   }

   pre .keyword {
     color: #900;
     font-weight: bold
   }

   pre .identifier {
     color: rgb(0, 0, 0);
   }

   pre .string {
     color: #d14;
   }
</style>

<!-- R syntax highlighter -->
<script type="text/javascript">
var hljs=new function(){function m(p){return p.replace(/&/gm,"&amp;").replace(/</gm,"&lt;")}function f(r,q,p){return RegExp(q,"m"+(r.cI?"i":"")+(p?"g":""))}function b(r){for(var p=0;p<r.childNodes.length;p++){var q=r.childNodes[p];if(q.nodeName=="CODE"){return q}if(!(q.nodeType==3&&q.nodeValue.match(/\s+/))){break}}}function h(t,s){var p="";for(var r=0;r<t.childNodes.length;r++){if(t.childNodes[r].nodeType==3){var q=t.childNodes[r].nodeValue;if(s){q=q.replace(/\n/g,"")}p+=q}else{if(t.childNodes[r].nodeName=="BR"){p+="\n"}else{p+=h(t.childNodes[r])}}}if(/MSIE [678]/.test(navigator.userAgent)){p=p.replace(/\r/g,"\n")}return p}function a(s){var r=s.className.split(/\s+/);r=r.concat(s.parentNode.className.split(/\s+/));for(var q=0;q<r.length;q++){var p=r[q].replace(/^language-/,"");if(e[p]){return p}}}function c(q){var p=[];(function(s,t){for(var r=0;r<s.childNodes.length;r++){if(s.childNodes[r].nodeType==3){t+=s.childNodes[r].nodeValue.length}else{if(s.childNodes[r].nodeName=="BR"){t+=1}else{if(s.childNodes[r].nodeType==1){p.push({event:"start",offset:t,node:s.childNodes[r]});t=arguments.callee(s.childNodes[r],t);p.push({event:"stop",offset:t,node:s.childNodes[r]})}}}}return t})(q,0);return p}function k(y,w,x){var q=0;var z="";var s=[];function u(){if(y.length&&w.length){if(y[0].offset!=w[0].offset){return(y[0].offset<w[0].offset)?y:w}else{return w[0].event=="start"?y:w}}else{return y.length?y:w}}function t(D){var A="<"+D.nodeName.toLowerCase();for(var B=0;B<D.attributes.length;B++){var C=D.attributes[B];A+=" "+C.nodeName.toLowerCase();if(C.value!==undefined&&C.value!==false&&C.value!==null){A+='="'+m(C.value)+'"'}}return A+">"}while(y.length||w.length){var v=u().splice(0,1)[0];z+=m(x.substr(q,v.offset-q));q=v.offset;if(v.event=="start"){z+=t(v.node);s.push(v.node)}else{if(v.event=="stop"){var p,r=s.length;do{r--;p=s[r];z+=("</"+p.nodeName.toLowerCase()+">")}while(p!=v.node);s.splice(r,1);while(r<s.length){z+=t(s[r]);r++}}}}return z+m(x.substr(q))}function j(){function q(x,y,v){if(x.compiled){return}var u;var s=[];if(x.k){x.lR=f(y,x.l||hljs.IR,true);for(var w in x.k){if(!x.k.hasOwnProperty(w)){continue}if(x.k[w] instanceof Object){u=x.k[w]}else{u=x.k;w="keyword"}for(var r in u){if(!u.hasOwnProperty(r)){continue}x.k[r]=[w,u[r]];s.push(r)}}}if(!v){if(x.bWK){x.b="\\b("+s.join("|")+")\\s"}x.bR=f(y,x.b?x.b:"\\B|\\b");if(!x.e&&!x.eW){x.e="\\B|\\b"}if(x.e){x.eR=f(y,x.e)}}if(x.i){x.iR=f(y,x.i)}if(x.r===undefined){x.r=1}if(!x.c){x.c=[]}x.compiled=true;for(var t=0;t<x.c.length;t++){if(x.c[t]=="self"){x.c[t]=x}q(x.c[t],y,false)}if(x.starts){q(x.starts,y,false)}}for(var p in e){if(!e.hasOwnProperty(p)){continue}q(e[p].dM,e[p],true)}}function d(B,C){if(!j.called){j();j.called=true}function q(r,M){for(var L=0;L<M.c.length;L++){if((M.c[L].bR.exec(r)||[null])[0]==r){return M.c[L]}}}function v(L,r){if(D[L].e&&D[L].eR.test(r)){return 1}if(D[L].eW){var M=v(L-1,r);return M?M+1:0}return 0}function w(r,L){return L.i&&L.iR.test(r)}function K(N,O){var M=[];for(var L=0;L<N.c.length;L++){M.push(N.c[L].b)}var r=D.length-1;do{if(D[r].e){M.push(D[r].e)}r--}while(D[r+1].eW);if(N.i){M.push(N.i)}return f(O,M.join("|"),true)}function p(M,L){var N=D[D.length-1];if(!N.t){N.t=K(N,E)}N.t.lastIndex=L;var r=N.t.exec(M);return r?[M.substr(L,r.index-L),r[0],false]:[M.substr(L),"",true]}function z(N,r){var L=E.cI?r[0].toLowerCase():r[0];var M=N.k[L];if(M&&M instanceof Array){return M}return false}function F(L,P){L=m(L);if(!P.k){return L}var r="";var O=0;P.lR.lastIndex=0;var M=P.lR.exec(L);while(M){r+=L.substr(O,M.index-O);var N=z(P,M);if(N){x+=N[1];r+='<span class="'+N[0]+'">'+M[0]+"</span>"}else{r+=M[0]}O=P.lR.lastIndex;M=P.lR.exec(L)}return r+L.substr(O,L.length-O)}function J(L,M){if(M.sL&&e[M.sL]){var r=d(M.sL,L);x+=r.keyword_count;return r.value}else{return F(L,M)}}function I(M,r){var L=M.cN?'<span class="'+M.cN+'">':"";if(M.rB){y+=L;M.buffer=""}else{if(M.eB){y+=m(r)+L;M.buffer=""}else{y+=L;M.buffer=r}}D.push(M);A+=M.r}function G(N,M,Q){var R=D[D.length-1];if(Q){y+=J(R.buffer+N,R);return false}var P=q(M,R);if(P){y+=J(R.buffer+N,R);I(P,M);return P.rB}var L=v(D.length-1,M);if(L){var O=R.cN?"</span>":"";if(R.rE){y+=J(R.buffer+N,R)+O}else{if(R.eE){y+=J(R.buffer+N,R)+O+m(M)}else{y+=J(R.buffer+N+M,R)+O}}while(L>1){O=D[D.length-2].cN?"</span>":"";y+=O;L--;D.length--}var r=D[D.length-1];D.length--;D[D.length-1].buffer="";if(r.starts){I(r.starts,"")}return R.rE}if(w(M,R)){throw"Illegal"}}var E=e[B];var D=[E.dM];var A=0;var x=0;var y="";try{var s,u=0;E.dM.buffer="";do{s=p(C,u);var t=G(s[0],s[1],s[2]);u+=s[0].length;if(!t){u+=s[1].length}}while(!s[2]);if(D.length>1){throw"Illegal"}return{r:A,keyword_count:x,value:y}}catch(H){if(H=="Illegal"){return{r:0,keyword_count:0,value:m(C)}}else{throw H}}}function g(t){var p={keyword_count:0,r:0,value:m(t)};var r=p;for(var q in e){if(!e.hasOwnProperty(q)){continue}var s=d(q,t);s.language=q;if(s.keyword_count+s.r>r.keyword_count+r.r){r=s}if(s.keyword_count+s.r>p.keyword_count+p.r){r=p;p=s}}if(r.language){p.second_best=r}return p}function i(r,q,p){if(q){r=r.replace(/^((<[^>]+>|\t)+)/gm,function(t,w,v,u){return w.replace(/\t/g,q)})}if(p){r=r.replace(/\n/g,"<br>")}return r}function n(t,w,r){var x=h(t,r);var v=a(t);var y,s;if(v){y=d(v,x)}else{return}var q=c(t);if(q.length){s=document.createElement("pre");s.innerHTML=y.value;y.value=k(q,c(s),x)}y.value=i(y.value,w,r);var u=t.className;if(!u.match("(\\s|^)(language-)?"+v+"(\\s|$)")){u=u?(u+" "+v):v}if(/MSIE [678]/.test(navigator.userAgent)&&t.tagName=="CODE"&&t.parentNode.tagName=="PRE"){s=t.parentNode;var p=document.createElement("div");p.innerHTML="<pre><code>"+y.value+"</code></pre>";t=p.firstChild.firstChild;p.firstChild.cN=s.cN;s.parentNode.replaceChild(p.firstChild,s)}else{t.innerHTML=y.value}t.className=u;t.result={language:v,kw:y.keyword_count,re:y.r};if(y.second_best){t.second_best={language:y.second_best.language,kw:y.second_best.keyword_count,re:y.second_best.r}}}function o(){if(o.called){return}o.called=true;var r=document.getElementsByTagName("pre");for(var p=0;p<r.length;p++){var q=b(r[p]);if(q){n(q,hljs.tabReplace)}}}function l(){if(window.addEventListener){window.addEventListener("DOMContentLoaded",o,false);window.addEventListener("load",o,false)}else{if(window.attachEvent){window.attachEvent("onload",o)}else{window.onload=o}}}var e={};this.LANGUAGES=e;this.highlight=d;this.highlightAuto=g;this.fixMarkup=i;this.highlightBlock=n;this.initHighlighting=o;this.initHighlightingOnLoad=l;this.IR="[a-zA-Z][a-zA-Z0-9_]*";this.UIR="[a-zA-Z_][a-zA-Z0-9_]*";this.NR="\\b\\d+(\\.\\d+)?";this.CNR="\\b(0[xX][a-fA-F0-9]+|(\\d+(\\.\\d*)?|\\.\\d+)([eE][-+]?\\d+)?)";this.BNR="\\b(0b[01]+)";this.RSR="!|!=|!==|%|%=|&|&&|&=|\\*|\\*=|\\+|\\+=|,|\\.|-|-=|/|/=|:|;|<|<<|<<=|<=|=|==|===|>|>=|>>|>>=|>>>|>>>=|\\?|\\[|\\{|\\(|\\^|\\^=|\\||\\|=|\\|\\||~";this.ER="(?![\\s\\S])";this.BE={b:"\\\\.",r:0};this.ASM={cN:"string",b:"'",e:"'",i:"\\n",c:[this.BE],r:0};this.QSM={cN:"string",b:'"',e:'"',i:"\\n",c:[this.BE],r:0};this.CLCM={cN:"comment",b:"//",e:"$"};this.CBLCLM={cN:"comment",b:"/\\*",e:"\\*/"};this.HCM={cN:"comment",b:"#",e:"$"};this.NM={cN:"number",b:this.NR,r:0};this.CNM={cN:"number",b:this.CNR,r:0};this.BNM={cN:"number",b:this.BNR,r:0};this.inherit=function(r,s){var p={};for(var q in r){p[q]=r[q]}if(s){for(var q in s){p[q]=s[q]}}return p}}();hljs.LANGUAGES.cpp=function(){var a={keyword:{"false":1,"int":1,"float":1,"while":1,"private":1,"char":1,"catch":1,"export":1,virtual:1,operator:2,sizeof:2,dynamic_cast:2,typedef:2,const_cast:2,"const":1,struct:1,"for":1,static_cast:2,union:1,namespace:1,unsigned:1,"long":1,"throw":1,"volatile":2,"static":1,"protected":1,bool:1,template:1,mutable:1,"if":1,"public":1,friend:2,"do":1,"return":1,"goto":1,auto:1,"void":2,"enum":1,"else":1,"break":1,"new":1,extern:1,using:1,"true":1,"class":1,asm:1,"case":1,typeid:1,"short":1,reinterpret_cast:2,"default":1,"double":1,register:1,explicit:1,signed:1,typename:1,"try":1,"this":1,"switch":1,"continue":1,wchar_t:1,inline:1,"delete":1,alignof:1,char16_t:1,char32_t:1,constexpr:1,decltype:1,noexcept:1,nullptr:1,static_assert:1,thread_local:1,restrict:1,_Bool:1,complex:1},built_in:{std:1,string:1,cin:1,cout:1,cerr:1,clog:1,stringstream:1,istringstream:1,ostringstream:1,auto_ptr:1,deque:1,list:1,queue:1,stack:1,vector:1,map:1,set:1,bitset:1,multiset:1,multimap:1,unordered_set:1,unordered_map:1,unordered_multiset:1,unordered_multimap:1,array:1,shared_ptr:1}};return{dM:{k:a,i:"</",c:[hljs.CLCM,hljs.CBLCLM,hljs.QSM,{cN:"string",b:"'\\\\?.",e:"'",i:"."},{cN:"number",b:"\\b(\\d+(\\.\\d*)?|\\.\\d+)(u|U|l|L|ul|UL|f|F)"},hljs.CNM,{cN:"preprocessor",b:"#",e:"$"},{cN:"stl_container",b:"\\b(deque|list|queue|stack|vector|map|set|bitset|multiset|multimap|unordered_map|unordered_set|unordered_multiset|unordered_multimap|array)\\s*<",e:">",k:a,r:10,c:["self"]}]}}}();hljs.LANGUAGES.r={dM:{c:[hljs.HCM,{cN:"number",b:"\\b0[xX][0-9a-fA-F]+[Li]?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+(?:[eE][+\\-]?\\d*)?L\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\b\\d+\\.(?!\\d)(?:i\\b)?",e:hljs.IMMEDIATE_RE,r:1},{cN:"number",b:"\\b\\d+(?:\\.\\d*)?(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"number",b:"\\.\\d+(?:[eE][+\\-]?\\d*)?i?\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"keyword",b:"(?:tryCatch|library|setGeneric|setGroupGeneric)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\.",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\.\\.\\d+(?![\\w.])",e:hljs.IMMEDIATE_RE,r:10},{cN:"keyword",b:"\\b(?:function)",e:hljs.IMMEDIATE_RE,r:2},{cN:"keyword",b:"(?:if|in|break|next|repeat|else|for|return|switch|while|try|stop|warning|require|attach|detach|source|setMethod|setClass)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"literal",b:"(?:NA|NA_integer_|NA_real_|NA_character_|NA_complex_)\\b",e:hljs.IMMEDIATE_RE,r:10},{cN:"literal",b:"(?:NULL|TRUE|FALSE|T|F|Inf|NaN)\\b",e:hljs.IMMEDIATE_RE,r:1},{cN:"identifier",b:"[a-zA-Z.][a-zA-Z0-9._]*\\b",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"<\\-(?!\\s*\\d)",e:hljs.IMMEDIATE_RE,r:2},{cN:"operator",b:"\\->|<\\-",e:hljs.IMMEDIATE_RE,r:1},{cN:"operator",b:"%%|~",e:hljs.IMMEDIATE_RE},{cN:"operator",b:">=|<=|==|!=|\\|\\||&&|=|\\+|\\-|\\*|/|\\^|>|<|!|&|\\||\\$|:",e:hljs.IMMEDIATE_RE,r:0},{cN:"operator",b:"%",e:"%",i:"\\n",r:1},{cN:"identifier",b:"`",e:"`",r:0},{cN:"string",b:'"',e:'"',c:[hljs.BE],r:0},{cN:"string",b:"'",e:"'",c:[hljs.BE],r:0},{cN:"paren",b:"[[({\\])}]",e:hljs.IMMEDIATE_RE,r:0}]}};
hljs.initHighlightingOnLoad();
</script>

<!-- MathJax scripts -->
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<!-- 
%\VignetteEngine{knitr::knitr}
%\VignetteIndexEntry{Principal Components Analysis of LMM models}
-->

<p>In a linear mixed model (LMM) incorporating vector-valued random
effects, say by-subject random effects for intercept and for slope,
the <em>variance component</em> parameters determine a variance-covariance
matrix for these random effects.</p>

<p>As described in @Bates:Maechler:Bolker:Walker:2015
the parameters used in fitting the model are the entries in the
Cholesky factor, \(\Lambda\), of the relative variance-covariance
matrix of the unconditional distribution of the random effects.</p>

<p>Consider a <em>maximal model</em> fit to the <code>KWDYZ</code> data from @Kliegl:Wei:Dambacher:Yan:Zhou:2011, available in this package,</p>

<pre><code class="r">summary(m0 &lt;- lmer(rt ~ 1+c1+c2+c3 + (1+c1+c2+c3|subj), KWDYZ, REML=FALSE))
</code></pre>

<pre><code>Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]
Formula: rt ~ 1 + c1 + c2 + c3 + (1 + c1 + c2 + c3 | subj)
   Data: KWDYZ

     AIC      BIC   logLik deviance df.resid 
  325840   325964  -162905   325810    28695 

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-4.495 -0.564 -0.084  0.462  5.604 

Random effects:
 Groups   Name        Variance Std.Dev. Corr             
 subj     (Intercept) 3047.1   55.20                     
          c1           540.5   23.25     0.60            
          c2           115.7   10.75    -0.13 -0.01      
          c3            90.4    9.51    -0.25 -0.85  0.36
 Residual             4876.9   69.83                     
Number of obs: 28710, groups:  subj, 61

Fixed effects:
            Estimate Std. Error t value
(Intercept)   389.73       7.09    55.0
c1             33.78       3.29    10.3
c2             13.99       2.31     6.1
c3              2.75       2.21     1.2

Correlation of Fixed Effects:
   (Intr) c1     c2    
c1  0.561              
c2 -0.078 -0.229       
c3 -0.136 -0.422  0.456
</code></pre>

<p>The parameter vector, \(\theta\), for this model</p>

<pre><code class="r">zapsmall(getME(m0,&quot;theta&quot;))
</code></pre>

<pre><code>   subj.(Intercept) subj.c1.(Intercept) subj.c2.(Intercept) subj.c3.(Intercept) 
            0.79044             0.20105            -0.02023            -0.03389 
            subj.c1          subj.c2.c1          subj.c3.c1             subj.c2 
            0.26533             0.01377            -0.11913             0.15204 
         subj.c3.c2             subj.c3 
            0.05662             0.00000 
</code></pre>

<p>(The <code>zapsmall</code> function, used here and in what follows, sets the format for printing a numerical vector or matrix so that very small elements do not cause a shift to scientific notation.  In scientific notation it is more difficult to see at a glance which numbers are large and which are small.)</p>

<p>These 10 parameter values are the values on and below the diagonal of a lower triangular Cholesky factor</p>

<pre><code class="r">zapsmall(chf &lt;- getME(m0,&quot;Tlist&quot;)[[1]])
</code></pre>

<pre><code>         [,1]     [,2]    [,3] [,4]
[1,]  0.79044  0.00000 0.00000    0
[2,]  0.20105  0.26533 0.00000    0
[3,] -0.02023  0.01377 0.15204    0
[4,] -0.03389 -0.11913 0.05662    0
</code></pre>

<p>The \(\theta\) vector elements fill the lower triangular matrix in <em>column major order</em>.  That is, the first four elements of the vector are the first column, the next three are the elements on and below the diagonal of the second column, etc.</p>

<p>The <em>relative covariance</em> matrix for the random effects is \(\Lambda\Lambda'\), which can be evaluated as</p>

<pre><code class="r">tcrossprod(chf)
</code></pre>

<pre><code>          [,1]        [,2]        [,3]       [,4]
[1,]  0.624795  0.15892054 -0.01598871 -0.0267886
[2,]  0.158921  0.11082378 -0.00041288 -0.0384225
[3,] -0.015989 -0.00041288  0.02371481  0.0076532
[4,] -0.026789 -0.03842249  0.00765319  0.0185458
</code></pre>

<p>(The expression <code>crossprod(X)</code> forms \(X'X\) and <code>tcrossprod(X)</code> forms \(XX'\).)</p>

<p>To reproduce the covariance matrix <code>tcrossprod(chf)</code> must be scaled by \(s^2\)</p>

<pre><code class="r">tcrossprod(getME(m0,&quot;sigma&quot;)*chf)
</code></pre>

<pre><code>         [,1]      [,2]     [,3]     [,4]
[1,] 3047.063  775.0402 -77.9754 -130.645
[2,]  775.040  540.4770  -2.0136 -187.383
[3,]  -77.975   -2.0136 115.6549   37.324
[4,] -130.645 -187.3828  37.3239   90.446
</code></pre>

<p>(Compare the diagonal entries of this result with the <em>variance components</em> of the random effects listed in the model summary.)</p>

<p>The (unconditional) correlation matrix of the random effects is obtained by scaling each row of \(\Lambda\) to have unit length, then applying <code>tcrossprod</code>.</p>

<pre><code class="r">(rowlengths &lt;- sqrt(rowSums(chf*chf)))
</code></pre>

<pre><code>[1] 0.79044 0.33290 0.15400 0.13618
</code></pre>

<pre><code class="r">tcrossprod((1/rowlengths)*chf)
</code></pre>

<pre><code>         [,1]       [,2]       [,3]     [,4]
[1,]  1.00000  0.6039416 -0.1313515 -0.24886
[2,]  0.60394  1.0000000 -0.0080537 -0.84751
[3,] -0.13135 -0.0080537  1.0000000  0.36493
[4,] -0.24886 -0.8475130  0.3649304  1.00000
</code></pre>

<p>(Compare the off-diagonal elements of this matrix with the correlations in the model summary.)</p>

<h2>Singularity in the Cholesky factor</h2>

<p>Some of the material in this section gets a bit technical.  Don&#39;t be too concerned if parts seem unintelligible.</p>

<p>Because the last column of <code>chf</code> is the zero vector, <code>chf</code> is rank-deficient.  Although it is a 4x4 matrix, the linear subspace formed by all possible linear combinations of the columns is 3-dimensional.  The random-effects vectors that can be generated from this fitted model must lie in this 3-dimensional subspace.  That is, there will be no variability in one direction of the space of random effects.</p>

<p>The <em>singular value decomposition</em> of <code>chf</code></p>

<pre><code class="r">(svd0 &lt;- svd(chf,nv=0))
</code></pre>

<pre><code>$d
[1] 8.1998e-01 2.8205e-01 1.6110e-01 6.9411e-08

$u
          [,1]      [,2]       [,3]      [,4]
[1,] -0.959412  0.272260 -0.0040066 -0.073403
[2,] -0.275353 -0.864162 -0.1295293  0.400782
[3,]  0.024482 -0.013595 -0.9474426 -0.318698
[4,]  0.055777  0.422981 -0.2925040  0.855814
</code></pre>

<p>returns the singular values, <code>d</code>, and the matrix of <em>left singular vectors</em>, <code>u</code>.  In the language of principal components analysis (PCA), the columns of <code>u</code> are the component loadings.  These columns have unit length and are mutually orthogonal.</p>

<pre><code class="r">zapsmall(crossprod(svd0$u))
</code></pre>

<pre><code>     [,1] [,2] [,3] [,4]
[1,]    1    0    0    0
[2,]    0    1    0    0
[3,]    0    0    1    0
[4,]    0    0    0    1
</code></pre>

<p>The singular values, <code>svd0$d</code>, are on the standard deviation scale.  To convert them to standard deviations on the scale of the response, multiply by the estimate of \(\sigma\).</p>

<pre><code class="r">zapsmall(getME(m0,&quot;sigma&quot;)*svd0$d)
</code></pre>

<pre><code>[1] 57.263 19.697 11.250  0.000
</code></pre>

<p>A more meaningful scaling, as used in PCA, is to consider the proportion of the overall variance accounted for by each component.</p>

<pre><code class="r">vc &lt;- svd0$d^2   # variances of principal components
zapsmall(vc/sum(vc))
</code></pre>

<pre><code>[1] 0.86436 0.10227 0.03336 0.00000
</code></pre>

<p>The principal components are ordered so that the first component accounts for the largest proportion of the variance, the second component accounts for the second largest proportion, and so on.  This ordering is enforced by the singular values which are defined to be non-negative values in decreasing order.</p>

<p>The cumulative proportion of the variance shows how what proportion is in the subspace spanned by the first principal component, the first two components, the first three components and so on, indicating how many components we should retain.</p>

<pre><code class="r">cumsum(vc/sum(vc))
</code></pre>

<pre><code>[1] 0.86436 0.96664 1.00000 1.00000
</code></pre>

<p>We see that 100% of the variance is accounted for by the first three principal components, which is another way of saying that the covariance matrix is of rank 3. Furthermore, 96.7% of the variance in the random effects is in the first two prinipal components, indicating that it should be possible to reduce the model from three to two dimensions without too much of a drop in the quality of the fit.</p>

<h2>Using the <code>rePCA</code> function</h2>

<p>The <code>rePCA</code> (<strong>r</strong>andom-<strong>e</strong>ffects <strong>P</strong>rincipal <strong>C</strong>omponents <strong>A</strong>nalysis) function takes a object of class <code>lmerMod</code> (i.e. a model fit by <code>lmer</code>) and performs the steps decribed above to produce a list of <code>prcomp</code> objects.</p>

<pre><code class="r">prc &lt;- rePCA(m0)
class(prc)
</code></pre>

<pre><code>[1] &quot;prcomplist&quot;
</code></pre>

<pre><code class="r">length(prc)
</code></pre>

<pre><code>[1] 1
</code></pre>

<pre><code class="r">names(prc)
</code></pre>

<pre><code>[1] &quot;subj&quot;
</code></pre>

<pre><code class="r">class(prc$subj)
</code></pre>

<pre><code>[1] &quot;prcomp&quot;
</code></pre>

<pre><code class="r">prc$subj
</code></pre>

<pre><code>Standard deviations:
[1] 8.1998e-01 2.8205e-01 1.6110e-01 6.9411e-08

Rotation:
          [,1]      [,2]       [,3]      [,4]
[1,] -0.959412  0.272260 -0.0040066 -0.073403
[2,] -0.275353 -0.864162 -0.1295293  0.400782
[3,]  0.024482 -0.013595 -0.9474426 -0.318698
[4,]  0.055777  0.422981 -0.2925040  0.855814
</code></pre>

<pre><code class="r">summary(prc$subj)
</code></pre>

<pre><code>Importance of components:
                        [,1]  [,2]   [,3]     [,4]
Standard deviation     0.820 0.282 0.1611 6.94e-08
Proportion of Variance 0.864 0.102 0.0334 0.00e+00
Cumulative Proportion  0.864 0.967 1.0000 1.00e+00
</code></pre>

<p>The <code>prcomplist</code> class has its own <code>summary</code> method, which simply applies <code>summary</code> to each element of the list.</p>

<h2>Multiple random-effects terms for the same grouping factor</h2>

<p>When several random-effects terms have the same grouping, the Cholesky factors from the terms are accumulated in a <em>block-diagonal</em> matrix. For example, in the <em>zero correlation parameter</em> model</p>

<pre><code class="r">VarCorr(m1 &lt;- lmer(rt ~ 1+c1+c2+c3 + (1+c1+c2+c3||subj), KWDYZ, REML=FALSE))
</code></pre>

<pre><code> Groups   Name        Std.Dev.
 subj     (Intercept) 54.71   
 subj.1   c1          23.97   
 subj.2   c2          10.39   
 subj.3   c3           8.61   
 Residual             69.84   
</code></pre>

<p>the <code>&quot;Tlist&quot;</code> consists of four 1x1 matrices</p>

<pre><code class="r">getME(m1,&quot;Tlist&quot;)
</code></pre>

<pre><code>$subj
        [,1]
[1,] 0.78341

$subj
        [,1]
[1,] 0.34324

$subj
        [,1]
[1,] 0.14882

$subj
        [,1]
[1,] 0.12327
</code></pre>

<p>all named &ldquo;subj&rdquo;.  The <em>block diagonal</em> matrix, which in this case is simply a diagonal matrix, is created by</p>

<pre><code class="r">bdiag(getME(m1,&quot;Tlist&quot;))
</code></pre>

<pre><code>4 x 4 sparse Matrix of class &quot;dgCMatrix&quot;

[1,] 0.78341 .       .       .      
[2,] .       0.34324 .       .      
[3,] .       .       0.14882 .      
[4,] .       .       .       0.12327
</code></pre>

<p>The singular value decomposition of a diagonal matrix is trivial; <code>d</code> is the diagonal of the matrix and <code>u</code> is the identity.</p>

<pre><code class="r">svd(bdiag(getME(m1,&quot;Tlist&quot;)),nv=0)
</code></pre>

<pre><code>$d
[1] 0.78341 0.34324 0.14882 0.12327

$u
     [,1] [,2] [,3] [,4]
[1,]    1    0    0    0
[2,]    0    1    0    0
[3,]    0    0    1    0
[4,]    0    0    0    1
</code></pre>

<pre><code class="r">summary(rePCA(m1))
</code></pre>

<pre><code>$subj
Importance of components:
                        [,1]  [,2]   [,3]   [,4]
Standard deviation     0.783 0.343 0.1488 0.1233
Proportion of Variance 0.798 0.153 0.0288 0.0198
Cumulative Proportion  0.798 0.951 0.9802 1.0000
</code></pre>

<p>The <em>block diagonal</em> nature of the Cholesky factor is better illustrated with the results of the model</p>

<pre><code class="r">VarCorr(m2 &lt;- lmer(rt ~ 1+c1+c2+c3 + (1+c1+c2|subj) + (0+c3|subj), KWDYZ, REML=FALSE))
</code></pre>

<pre><code> Groups   Name        Std.Dev. Corr       
 subj     (Intercept) 55.20               
          c1          23.17     0.61      
          c2           9.41    -0.05  0.34
 subj.1   c3           7.86               
 Residual             69.85               
</code></pre>

<pre><code class="r">(chf &lt;- bdiag(getME(m2,&quot;Tlist&quot;)))
</code></pre>

<pre><code>4 x 4 sparse Matrix of class &quot;dgCMatrix&quot;

[1,]  0.7902842 .        .       .      
[2,]  0.2009829 0.263981 .       .      
[3,] -0.0070212 0.062465 0.11922 .      
[4,]  .         .        .       0.11257
</code></pre>

<pre><code class="r">svd(chf,nu=0,nv=0)
</code></pre>

<pre><code>$d
[1] 0.81831 0.26448 0.11491 0.11257
</code></pre>

<pre><code class="r">summary(rePCA(m2))
</code></pre>

<pre><code>$subj
Importance of components:
                        [,1]   [,2]   [,3]   [,4]
Standard deviation     0.818 0.2645 0.1149 0.1126
Proportion of Variance 0.875 0.0914 0.0173 0.0165
Cumulative Proportion  0.875 0.9662 0.9835 1.0000
</code></pre>

<h2>Two or more grouping factors</h2>

<p>When a model incorporates random effects with repect to two or more grouping factors, such as this model fit to the <code>kb07</code> data from @Kronmuller:Barr:2007 and also discussed in @Barr:Levy:Scheepers:Tily:13</p>

<pre><code class="r">m3 &lt;- lmer(RTtrunc ~ 1+S+P+C+SP+SC+PC+SPC + (1|subj) + (1+P|item), kb07, REML=FALSE)
print(summary(m3),corr=FALSE)
</code></pre>

<pre><code>Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]
Formula: RTtrunc ~ 1 + S + P + C + SP + SC + PC + SPC + (1 | subj) + (1 +      P | item)
   Data: kb07

     AIC      BIC   logLik deviance df.resid 
   28692    28763   -14333    28666     1777 

Scaled residuals: 
   Min     1Q Median     3Q    Max 
-2.656 -0.589 -0.157  0.416  4.397 

Random effects:
 Groups   Name        Variance Std.Dev. Corr 
 subj     (Intercept)  89104   299           
 item     (Intercept) 132399   364           
          P            63832   253      -0.69
 Residual             458506   677           
Number of obs: 1790, groups:  subj, 56; item, 32

Fixed effects:
            Estimate Std. Error t value
(Intercept)  2180.57      77.36   28.19
S             -67.11      16.01   -4.19
P            -333.76      47.44   -7.03
C              79.05      16.01    4.94
SP             22.21      16.01    1.39
SC            -18.81      16.01   -1.18
PC              5.14      16.01    0.32
SPC           -24.01      16.01   -1.50
</code></pre>

<p>the <code>rePCA</code> function produces a list of <code>prcomp</code> objects, one for each grouping factor.</p>

<pre><code class="r">summary(rePCA(m3))
</code></pre>

<pre><code>$subj
Importance of components:
                        [,1]
Standard deviation     0.441
Proportion of Variance 1.000
Cumulative Proportion  1.000

$item
Importance of components:
                        [,1]  [,2]
Standard deviation     0.610 0.237
Proportion of Variance 0.869 0.131
Cumulative Proportion  0.869 1.000
</code></pre>

<h2>Summary</h2>

<p>Principal components analysis (PCA) of the estimated covariance matrices for the random effects in a linear mixed model allows for simple assessment of the dimensionality of the random effects distribution.  As shown in other vignettes in this <code>RePsychLing</code> package, the <em>maximal</em> model in many analyses of data from Psychology and Linguistics experiments, is almost always shown by this analysis to be degenerate.</p>

<h2>Package versions</h2>

<pre><code class="r">sessionInfo()
</code></pre>

<pre><code>R version 3.1.3 (2015-03-09)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 14.10

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C               LC_TIME=en_US.UTF-8       
 [4] LC_COLLATE=en_US.UTF-8     LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                  LC_ADDRESS=C              
[10] LC_TELEPHONE=C             LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
[1] knitr_1.9.5       RePsychLing_0.0.3 lme4_1.1-8        Rcpp_0.11.3      
[5] Matrix_1.1-4     

loaded via a namespace (and not attached):
 [1] devtools_1.7.0.9000 digest_0.6.8        evaluate_0.5.5      formatR_1.0        
 [5] grid_3.1.3          htmltools_0.2.6     lattice_0.20-30     markdown_0.7.4     
 [9] MASS_7.3-39         minqa_1.2.4         nlme_3.1-120        nloptr_1.0.4       
[13] rmarkdown_0.4.2     splines_3.1.3       stringr_0.6.2       tools_3.1.3        
[17] yaml_2.1.13        
</code></pre>

<h2>References</h2>

</body>

</html>
