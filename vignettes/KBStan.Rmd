---
title: "A Bayesian Linear Mixed Model Analysis of the Kronmueller and Barr (2007) data using Stan"
author: "Shravan Vasishth"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{KB07 Bayesian data analysis}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r preliminaries,echo=FALSE,include=FALSE,cache=FALSE}
library(lme4)
library(RePsychLing)
library(knitr)
library(rstan)
library(parallel)
opts_chunk$set(comment=NA)
options(width=92,show.signif.stars = FALSE)
```

## Load data

```{r preparedata,echo=TRUE,eval=FALSE,cache=FALSE}
load("../data/kb07.rda")
dat <- 
  c(unclass(subset(kb07, select = c(RTtrunc,
                                    S,P,C,SP,SC,
                                    PC,SPC))),
    subj = list(as.integer(kb07$subj)),
    item = list(as.integer(kb07$item)),    
    N = nrow(kb07),
    I = nlevels(kb07$subj),
    K = nlevels(kb07$item))
```

## Maximal model analysis

```{r runmaxmodel,echo=TRUE,eval=FALSE,cache=FALSE}
if (file.exists("../data/kb07_maxstanresults.rda")) {   
  ## this is a matrix object containing only
  ## a subset of the results
  load("../data/kb07_maxstanresults.rda") 
} else {
kb07model <- stan("KB07maxmodel.stan", 
                   data = dat, 
                   chains = 0)
  
## Adjust cores to match your computer:
sflist <- 
  mclapply(1:4, mc.cores = 4, 
           function(i) stan(fit = kb07model, 
                            data = dat,
                            iter=2000,
                            chains = 1, 
                            chain_id = i, 
                            refresh = -1))

## Note that this would be a huge file if saved:
KB07_stan <- sflist2stanfit(sflist)
  ## save as matrix
KB07mat<-as.matrix(KB07_stan)
KB07reduced<-KB07mat[,1:153]
param_names<-colnames(KB07reduced)
resultsKBmax<-matrix(rep(NA,153*3),ncol=3)
for(i in 1:153){
  resultsKBmax[i,]<-c(mean(KB07reduced[,i]),
                     quantile(KB07reduced[,i],
                     probs=c(0.025,0.975)))
}

resultsKBmax<-data.frame(resultsKBmax)
## Mean and credible intervals:
colnames(resultsKBmax)<-c("mean","lower","upper")
rownames(resultsKBmax)<-param_names

## saved in RePsychLing data dir:
save(resultsKBmax,
     file="../data/kb07_maxstanresults.rda",
     compress="xz")
```

### Final model

```{r runfinmodel,echo=TRUE,eval=FALSE,cache=FALSE}
if (file.exists("../data/kb07_finstanresults.rda")) {   
  ## this is a matrix object containing only
  ## a subset of the results
  load("../data/kb07_finstanresults.rda")
} else {
kb07finmodel <- stan("KB07finmodel.stan", 
                   data = dat, 
                   chains = 0)
  
## Adjust cores to match your computer:
sflist <- 
  mclapply(1:4, mc.cores = 4, 
           function(i) stan(fit = kb07finmodel, 
                            data = dat,
                            iter=3000,
                            chains = 1, 
                            chain_id = i, 
                            refresh = -1))

## note that this would be a huge file if saved:
KB07_finstan <- sflist2stanfit(sflist)
  ## save as matrix
KB07mat<-as.matrix(KB07_finstan)

## select all except correlation parameter:
KB07reduced<-KB07mat[,1:12]
param_names<-colnames(KB07reduced)
resultsKBfin<-matrix(rep(NA,12*3),ncol=3)
for(i in 1:12){
  resultsKBfin[i,]<-c(mean(KB07reduced[,i]),
                     quantile(KB07reduced[,i],
                     probs=c(0.025,0.975)))
}

resultsKBfin<-data.frame(resultsKBfin)
colnames(resultsKBfin)<-c("mean","lower","upper")

## saved in RePsychLing data dir:
save(resultsKBfin,
     file="../data/kb07_finstanresults.rda",
     compress="xz")
}
```

Extract correlation parameters:

```{r finmodelcorr,echo=TRUE,eval=FALSE,cache=FALSE}
## extract correlation parameters:
e<-extract(KB07_finstan)
n_samp <- dim(e[[1]])[1]
## correlations subject:
cor_listw <- lapply(seq(n_samp), 
                   function(i) {
  L <- e$L_w[i, , ]
  t(L) %*% L
})

# number of random effects
n_ran <- nrow(cor_listw[[1]])

## final lmer model:
kb7<-lmer(RTtrunc ~ 1 + S + P + C + 
            SP + SC + PC + SPC + 
            (1 | subj) + (1 + P | item),
          kb07)

kb7_cor_i <- attr(VarCorr(kb7)$item,
                  "correlation")

# create indices of correlation coefficients (upper triangular)
cor_idx_i <- which(upper.tri(kb7_cor_i), 
                   arr.ind = TRUE)

cor_summarykb7<-matrix(rep(NA,1*3),ncol=3)
## this for-loop is trivial but can be extended
## should the model change to something more complex:
for (i in 1:1) {
  idx <- cor_idx_i[i, , drop = FALSE]
  kb7_cor <- kb7_cor_i[idx]
  kb7i_cor <- sapply(cor_listw, "[", idx)
  ## Save means and credible intervals:
cor_summarykb7[i,1:3]<-c(mean(kb7i_cor),
                   quantile(kb7i_cor,
                           probs=c(0.025,
                                   0.975))) 
}
rownames(cor_summarykb7)<-"13"
```


```{r finmodelsave,echo=TRUE,eval=FALSE,cache=FALSE}
## Saved in RePsychLing data dir:
#save(resultsKBfin,
#     file="../data/kb07_finstanresults.rda",
#     compress="xz")

save(cor_summarykb7,
     file="../data/kb07_finstanresultscorr.rda",
     compress="xz")
```

```{r summaryresults,echo=TRUE,eval=FALSE,cache=FALSE}
## to be elaborated on
rownames(resultsKBfin)<-param_names
round(resultsKBfin,digits=2)
```


